# 20.5.3 웹 프락시 자동발견 프로토콜(WPAD)

- 웹 프락시 자동발견 프로토콜(WPAD)은 최종 사용자가 수동으로 프락시 설정을 할 필요도, 투명한 트래픽 인터셉트에 의존할 필요도 없이 웹브라우저가 근처의 프락시를 찾아내어 사용할 수 있게 해주는 방법을 제공하는 것을 목적으로 하고 있다.

## PAC 파일 자동발견

- WPAD는 HTTP 클라이언트가 PAC파일 위치를 알아내고 그 파일을 이용해서 적절한 프락시 서버의 이름을 알아낼 수 있게 해 준다.

  > PAC 파일은 `FindProxyForUrl` 이라는 함수를 정의하고 있는 파일

- WPAD 프로토콜은 설정 URL (CURL) 이라고 알려진 PAC 파일 URL을 발견한다. 이 PAC파일은 적절한 프락시 서버의 주소를 반환하는 자바스크립트 프로그램을 실행한다.

- WPAD 프로토콜을 구현한 HTTP 클라이언트

1. WPAD 를 이용해 PAC 파일 URL 을 찾는다
2. URL 에 해당하는 PAC 파일을 가져온다.
3. PAC 파일을 통해 알아낸 프락시 서버에 요청을 보낸다.

## WPAC의 알고리즘

- WPAD는 적절한 PAC파일 CURL을 결정하기 위해 여러 가지 리소스 발견 기법들을 사용한다.
  - DHCP(동적 호스트 설정 프로토콜), SLP(서비스 위치 프로토콜), DNS 에게 잘 알려진 호스트명, DNS 의 SRV 레코드, TXT 레코드의 DNS 서비스 Url들
- WPAD 클라이언트에게는 오직 DHCP와 DNS에게 잘 알려진 호스트 명 기법만이 요구된다
- WPAD 클라이언트는 앞에서 언급한 발견 메커니즘을 이용해서 리소스 발견 요청을 순서대로 보낸다. 발견 시도가 성공할 때마다, 클라이언트는 PAC CURL 을 생성하기 위해 취득한 정보를 사용한다
- 만약 PAC파일이 이 CURL 에서 성공적으로 발견되었다면 과정은 종료한다.
  - 만약 모든 발견 매커니즘을 시행한 이후에도 PAC 파일을 찾지 못했다면 WPAD 프로토콜을 실패로 돌아가고 프락시 서버를 사용하지 않는다.
- 클라이언트는 DHCP, SLP 시도한다.
  - DNS SRV, 잘 알려진 호스트명들, 그리고 DNS TXT 레코드 방법을 여러 차례 순환한다. 매번 DNS 쿼리 QNAME은 점점 덜 구체적이게 된다
  - 모든 DNS 룩업은 wpad 접두어 가 붙은 QNAME 을 갖는다. (`QNAME = wpad.development.foo.com`)

## DHCP를 이용한 CURL 발견

- WPAD 클라이언트가 질의하는 DHCP 서버는 반드시 CURL을 저장하고 있어야 한다.
- WPAD클라이언트는 DHCP 질의를 DHCP 서버에 보냄으로써 CURL을 얻는다.
- CURL 은 DHCP 옵션 코드 252 에 문자열 형태로 들어있다.
- WPAD클라이언트가 자신의 초기화 과정에서 이미 DHCP 질의를 했다면, DHCP 서버는 이미 그 값을 제공했을 수 있다

## DNS A 레코드 룩업

- 이 메커니즘이 동작하려면, 알맞는 프락시 서버의 IP주소들이 WPAD 클라이언트들이 질의할 수 있는 DNS 서버에 반드시 저장되어 있어야 한다.
- WPAD 클라이언트는 A레코드 룩업을 DNS 서버로 보내 CURL을 얻는다/
- 룩업이 성공하면 적절한 프락시 서버의 IP주소를 얻는다

## PAC파일 가져오기

- 한번 후보 CURL이 생성되면, WPAD 클라이언트는 보통 그 CURL로 GET 요청을 만드는데, 이때 자신이 다룰 수 있는 적절한 CFILE 포맷 정보가 담긴 Accept 헤더를 포함해야 한다

```
Accept : application/x-ns-proxy-autoconfig
```

## 언제 WPAD를 실행하는가

- 웹 클라이언트가 시작될 때
- 클라이언트 호스트의 아이피 주소가 변경된 네트워킹 스택으로부터 어떤 언급이 있을 때마다
- PAC 파일이 만료되었을 때에도 WPAD 프로토콜을 재시작

## WPAD 스푸핑

- WPAD의 IE5구현은 사용자의 개입 없이 웹 클라이언트가 프락시 설정을 자동으로 탐지하는 것을 가능하게 했다.
- WPAD알고리즘은 호스트 명 'wpad'를 도메인 이름의 절대 표기 앞에 붙이고 WPAD 서버를 찾아내거나 3차 도메인에 도달할 때까지 계속해서 서브도메인을 지운다.
  - 도메인이 a.b.micro.com -> wpad.a.b.micro.com -> wpad.b.micro.com
  - 보안 취약점을 노출할 수 있기에 이후 버번에서 이 문제를 해결

## 타임아웃
- WPAD 는 여러 단계를 거치게 되는데 각 단계를 10초 이하 제한하는 것이 합리적이지만 더 적절한 다른 값을 선택할 수도 있다.
