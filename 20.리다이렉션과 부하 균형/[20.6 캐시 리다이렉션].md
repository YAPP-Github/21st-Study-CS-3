# 20.6. 캐시 리다이렉션 방법
- 서버로 리다이렉트, 프락시와 게이트웨이로 리다이렉트 하는 방법
## 20.6.1 WPAD 리다이렉션 

- WCCP(캐시 조직 프로토콜)은 라우터들과 캐시들 사이의 대화를 관리하여 라우터가 캐시를 검사하고 특정 종류의 트래픽을 특정 캐시로 보낼 수 있게 해준다

### WPAD 리다이렉션 동작 

- 네트워크가 필요하다. WCCP를 사용할 수 있는 라우터와, 다른 캐시와 의사소통할 수 있는 캐시가 포함되어야 한다
- 라우터들의 집합과 그들의 대상이 되는 캐시들의 WCCP 서비스 그룹을 구성한다
- 만약 서비스 그룹이 HTTP 트래픽을 리다이렉션 하도록 설정되어 있다면, 서비스 그룹의 라우터는 HTTP 요청을 서비스 그룹의 캐시로 보낸다
- HTTP 요청이 서비스 그룹의 라우터에 도착했을 때, 라우터는 그 요청을 처리하기 위해 서비스 그룹의 캐시 중 하나를 선택한다
- 라우터는 요청 패킷을, 캐시의 아이피 주소와 함께 캡슐화하거나 아이피 맥 포워딩을 하여 캐시로 보낸다
- 만약 캐시가 요청을 처리할 수 없다면, 패킷은 평범하게 포워딩되기 위해 라우터로 돌아온다
- 서비스 그룹의 구성원들은 지속적으로 다른 구성원들의 가용성을 확인하기 위해 하트비트 메시지를 교환한다.

## WCCP2 메시지들
- 헤더 정보, 구성 요소
  - 헤더 : 메시지의 종류, WCCP 버전, 메시지의 길이
     - HERE_I_AM : 캐시가 라우터에게 트래픽을 받을 수 있다고 전하는 메시지
    - I_SEE_YOU : HERE_I_AM 에 응답하는 메시지로 라우터가 캐시에게 전하는 메시지
    - REDIRECT_ASSIGN : 지정된 캐시가 라우터에게 부하 균형을 위해서 보내는 메시지
    - REMOVAL_QUERY : 라우터가 HERE_I_AM 메시지를 정기적으로 받지 못했다면 캐시가 서비스 그룹에서 삭제되어야 하는지 알아보기 위해 해당 메시지를 보낸다.
  - 구성요소 : 보안 정보, 서비스 정보, 라우터 식별 정보, 웹 캐시 식별 정보, 라우터 뷰 정보, 웹 캐시 뷰 정보, 할당 정보, 라우터 질의 정보, 능력 정보, 대체 할당, 할당 맵, 명령 확장

## 서비스 그룹
- WCCP 메시지를 교환할 수 있는 라우터나 캐시들의 집합
- 서비스 그룹의 설정을 통해 어떻게 트래픽이 서비스 그룹의 캐시들로 분산될지 결정

## GRE 패킷 캡슐화
- WCCP 지원하는 라우터들은 HTTP 패킷을 특정 서버의 IP 주소와 함께 캡슐화 
- 이 캡슐화는 일반 라우터 캡슐화(GRE) 임을 나타내는 IP 헤더 proto 필드를 포함
- 캡슐화가 되어있기에 클라이언트 아이피 주소를 잃어버리지 않음

## WCCP 부하 균형
- WCCP 라우터는 라우팅 뿐 아니라 여러 서버 간의 부하 균형을 유지
- 라우터와 수신 서버들은 자신이 정상적으로 동작하고 있음을 알려주기 위해 하트 비트 메시지를 서로 교환
  - 만약 특정 서버에서 하트 비트 메시지 오지 않는다면 WCCP 라우터는 트래픽 요청을 그 노드로 리다이렉트 하는 대신 인터넷을 보낸 다.
  