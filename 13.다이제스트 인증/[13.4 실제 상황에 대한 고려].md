# 13.4 실제 상황에 대한 고려

## 1. 다중 인증요구(13.4.1)

- 서버는 한 리소스에 대해 여러 인증을 요구할 수 있음
  - 예를 들어 `서버가 클라이언트의 능력을 모른다면 서버는 기본 및 다이제스트 인증요구를 모두 보낼것`
- 다중 인증요구에 직면했을 때 클라이언트는 `반드시 자신이 지원할 수 있는 가장 강력한 인증 메커니즘을 선택`해야 함!
- 사용자 에이전트는 `WWW-Authenticate나 Proxy-Authenticate` 헤더 필드의 값을 분석할 때 반드시 특별한 주의를 기울여야 함
  - 인증 요구 그 자체가 쉼표로 구분된 목록으로 된 여러개의 인증 매개변수들을 담을 수 있는 것과 마찬가지로 이 헤더들에 인증요구가 둘 이상 포함되거나 WWW-Authenticate 헤더가 둘 이상 제공될 수 있기 때문
  - 많은 브라우저가 오직 기본 인증만을 인식하고 그것이 서버가 제시한 첫번째 인증 메커니즘일 것을 요구한다는 점에 주의!
- 다양한 인증 옵션을 제공하는 경우 ‘가장 허약한 연결부분’에 대한 보안 우려가 있다는 것은 명확
- 서버는 기본 인증을 제한적으로만 사용해야 할 것이며 관리자는 사용자에게 보안 수준이 다른 여러 시스템에서 같은 비밀번호를 사용하는 것의 위험성에 대해 경고해야 할 것

## 2. 오류 처리(13.4.2)

- 다이제스트 인증에서 지시자나 그 값이 적절하지 않거나 요구된 지시자가 빠져있는 경우 알맞은 응답은 `400 Bad Request`
- 요청의 요약이 맞지 않으면 로그인이 실패했음을 기록해두는 것이 좋음
  - 반복된 실패는 공격자가 비밀번호 추측을 시도하고 있음을 의미
- 인증 서버는 `반드시 ‘uri’ 지시자가 가리키는 리소스가 요청줄에 명시된 리소스와 같음`을 확인해야 한다
  - 만약 다르다면 서버는 400 Bad Request 에러를 반환하는 것이 좋다
  - 이 필드와 요청 URL과의 중복된 정보는 중간의 프락시가 클라이언트의 요청줄을 변조했을 가능성에 대처할 수 있게 해준다
- 변형된 요청의 요약을 계산한 결과는 클라이언트가 계산한 요약과 다를 것이다

## 3. 보호 공간(13.4.3)

- 영역 값은 `접근한 서버의 루트 URL과 결합되어 보호공간을 정의`
- 영역은 `서버의 보호된 리소스들을 자신만의 인증 제도와 인가 데이터베이스 어느 한쪽 혹은 양쪽 모두를 가진 보호 영역의 집합으로 분할할 수 있도록 해줌`
- 영역값은 일반적으로 `원 서버에 의해 할당되는 문자열이며 인증 제도에 추가적인 의미를 더함`
- 인가 제도는 같지만 영역은 다른 다중 인증요구가 있을 수 있음에 주의
- 보호 공간은 어떤 자격이 자동으로 적용되는 영역을 결정
- 이전 요청이 인가되면 같은 자격은 인증 제도, 매개변수, 사용자 설정 중 한가지 이상에 의해 정해진 시간 동안 재사용 될 것
- 인증 제도에 별달리 정의된 것이 없다면 하나의 보호 공간은 서버 밖으로 확장될 수 없음. 보호공간의 구체적인 계산은 인증 메커니즘에 달려있다
  - 기본 인증에서 클라이언트는 요청 URl와 그 하위의 모든 경로는 같은 보호 공간에 있는 것으로 가정. 클라이언트는 이 공간에서 서버로부터의 또 다른 인증요구를 기다리지 않고 미리 리소스에 대한 인가를 받을 수 있다
  - 다이제스트 인증에서 인증요구의 WWW-Authenticate: domain필드는 보호 공간을 보다 엄밀하게 정의. domain 필드는 작은따옴표로 묶인 URI의 공백으로 분리된 목록. 이 목록의 모든 URI와 논리적으로 그 하위에 위치한 모든 URI는 같은 보호 공간에 있는 것으로 가정. 만약 domain 필드가 없거나 빈 값이라면 인증을 요구하는 서버의 모든 URI는 그 보호 공간에 있는 것이다

## 4. URI 다시 쓰기(13.4.4)

- 프락시는 가리키는 리소스의 변경없이 구문만 고쳐서 URI를 다시 쓰기도 한다
  - 호스트명은 정규화되거나 IP 주소로 대체될 수 있다
  - 문자들은 “%” escape 형식으로 대체될 수 있다
  - 특정 원 서버로부터 가져오는 리소스에 영향을 주지 않는, 타입에 대한 추가 속성이 URI의 끝에 붙거나 중간에 삽입될 수 있다
- 프락시가 URI를 변경할 수 있는 동시에 다이제스트 인증은 URI 값의 무결성을 검사하므로 다이제스트 인증은 이러한 변경에 의해 실패할 수 있다

## 5. 캐시(13.4.5)

- 어떤 공유 캐시가 Authorization 헤더를 포함한 요청과 그에 대한 응답을 받은 경우 다음의 두 Cache-Control 지시자 중 하나가 응답에 존재하지 않는 한 다른 요청에 대해 그 응답을 반환해서는 안된다
  - 만약 원 서버의 응답이 “must-revalidate” Cache-Control 지시자를 포함한 경우 캐시는 그 응답의 엔터티를 다음 요청에 대한 응답을 위해 활용할 것이다. 그러나 원 서버가 새 요청을 인증할 수 있도록 우선 그 요청의 헤더를 이용해서 재검사를 수행해야한다
  - 만약 원 서버의 응답이 “public” Cache-Control 지시자를 포함한 경우 응답 엔터티는 그다음에 오는 임의의 요청에 대한 응답으로 반환될 수 있다
