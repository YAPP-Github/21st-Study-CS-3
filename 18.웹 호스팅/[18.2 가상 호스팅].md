# 18.2 가상 호스팅

## 1. 개요

- `가상 호스팅(공유 호스팅)`
  - 많은 웹 호스팅 업자는 컴퓨터 한 대를 여러 고객이 공유하게 해서 저렴한 웹 호스팅 서비스를 제공한다
  - `각 웹 사이트는 다른 서버에서 호스팅하는것처럼 보이겠지만 사실은 물리적으로 같은 서버에서 호스팅되는 것`이다
  - 최종 사용자의 관점에서 가상 호스팅에 있는 웹 사이트는 물리적으로 분리된 전용 서버에서 호스팅하는 사이트와 구분할 수 없어야 한다

## 2. 호스트 정보가 없는 가상 서버 요청(18.2.1)

- 안타깝게도 HTTP/1.0에는 가상 호스팅 업자가 골머리를 앓을 만한 설계 관련 결함이 있다
- `HTTP/1.0 명세는 공용 웹 서버가 호스팅하고 있는 가상 웹 사이트에 누가 접근하고 있는지 식별하는 기능을 제공하지 않는다`
  - HTTP/1.0 요청은 요청 메시지에 URL의 경로 컴포넌트만 전송한다는 것을 다시 기억해보자
    - 만약 [http://www.joes-hardware.com/index.html](http://www.joes-hardware.com/index.html) 을 요청하면 브라우저는 www.joes-hardware.com에 연결을 하지만 HTTP/1.0 요청은 호스트명에 대한 별다른 언급 없이 `“GET /index.html”`이라는 요청을 한다
    - 서버가 여러개의 사이트를 가상 호스팅하고 있으면 사용자가 어떤 가상 웹 사이트로 접근하려고 하는 것인지 아는 데 필요한 정보가 충분하지 않다
  - 예시
    - 클라이언트 A가 [http://www.joes-hardware.com/index.html](http://www.joes-hardware.com/index.html) 에 접속하려고 하면 `“GET /index.html”` 요청이 공용 웹 서버에 전송된다
    - 클라이언트 B가 [http://www.marys-antiques.com/index.html](http://www.marys-antiques.com/index.html) 에 접속하려고 하면 위와 같은 `“GET /index.html”` 요청이 [joes-hardware.com](http://joes-hardware.com) 과 공유하고 있는 공용 웹 서버에 전송된다
  - 두 요청이 완전히 다른 문서를 요청을 하더라도 `요청 자체는 똑같이 생겼다`
  - HTTP 대리 서버(리버스 프락시)와 인터셉트 프락시 또한 `어떤 사이트를 요청하는지에 관한 정보가 필요하다`

## 3. 가상 호스팅 동작하게 하기(18.2.2)

- HTTP 초기 명세는 가상 호스팅을 고려하지 않았기 때문에 웹 로스팅 업자는 공용 가상 호스팅을 지원하는 데 필요한 차선책과 컨벤션을 개발해야 했다
  - 그 문제는 모든 HTTP요청 메시지에 경로 컴포넌트만 보내는 것이 아니라 완전한 URL도 포함해 보내게 해서 간단히 해결했다
- HTTP/1.1을 지원하는 서버는 HTTP요청 메시지에 있는 전체 URL을 처리할 수 있어야 한다
  - 하지만 기존에 있던 모든 애플리케이션이 이 명세에 맞춰 업그레이드하기까지는 오랜 시간이 걸릴 것이다
  - 그 와중에 네가지 기술이 나타났다
- `URL경로를 통한 가상 호스팅`
  - 서버가 어떤 사이트를 요청하는 것인지 알 수 있게 URL에 특별한 경로 컴포넌트를 추가한다
- `포트번호를 통한 가상 호스팅`
  - 각 사이트에 다른 포트번호를 할당하여 분리된 웹 서버의 인스턴스가 요청을 처리한다
- `IP 주소를 통한 가상 호스팅`
  - 각 가상 사이트에 별도의 IP주소를 할당하고 모든 IP 주소를 장비 하나에 연결한다. 웹 서버는 IP주소로 사이트 이름을 식별한다
- `Host 헤더를 통한 가상 호스팅`
  - 많은 웹 호스팅 업자들은 HTTP 설계자에게 이 문제를 해결해달라는 압력을 넣었다. HTTP/1.0의 개선 버전과 HTTP/1.1 의 공식 버전은 사이트 이름을 알려주는 Host 요청 헤더를 정의했다. 웹 서버는 Host 헤더로 가상 사이트를 식별할 수 있다

### `URL 경로를 통한 가상 호스팅`

- 공용 서버에 있는 각 가상 사이트에 `서로 다른 URL 경로`를 할당해서 각각을 강제로 구분할 수 있다.
- 예를 들어 논리적인 웹 사이트마다 `특정 경로`를 앞에 붙일 수 있다
  - 죠의 컴퓨터 가게는 [http://www.joes-hardware.com/joe/index.html](http://www.joes-hardware.com/index.html) 로 할 수 있다
  - 메리의 골동품 가게는 [http://www.marys-antiques.com/mary/index.htm](http://www.marys-antiques.com/index.html)l 로 할 수 있다
- 서버에 요청이 도착하면 호스트 명 정보가 요청에 포함되어있지는 않지만 경로에 있는 정보를 통해서 다음과 같이 이해한다
  - “GET `/joe/index.html`”은 죠의 컴퓨터 가게에 대한 요청이다
  - “GET `/mary/index.html`" 은 메리의 골동품 가게에 대한 요청이다
- 이는 좋은 해결책은 아니다
  - “/joe” 와 같은 접두어는 불필요하고 혼란스럽다
  - 게다가 일반적으로 홈페이지로 갈 때 사용하는 [http://www.joes-hardware.com](http://www.joes-hardware.com/index.html) 나[http://www.joes-hardware.com](http://www.joes-hardware.com/index.html)/index.html 같은 URL은 동작하지 않는다
- URL 기반의 가상 호스팅은 좋지 않은 방법이라 `거의 사용하지 않는다`

### `포트번호를 통한 가상 호스팅`

- 경로 명을 변경하는 대신, 죠와 메리는 웹 서버에 각각 다른 포트번호를 할당할 수 있다
- 예를 들어 80포트 대신에 `죠는 82, 메리는 83으로` 할 수 있다
- 하지만 사용자는 URL에 비표준 포트를 쓰지 않고서도 리소스를 찾길 원해서 문제가 있다

### `IP 주소를 통한 가상 호스팅`

- `각 가상 웹 사이트에 유일한 IP 주소를 한 개 이상 부여한다`
- 모든 가상 서버의 IP 주소는 같은 공용 서버에 연결되어 있다
- 서버는 HTTP 커넥션의 목적지 IP 주소를 보고 클라이언트가 어떤 웹 사이트에 연결하려고 하는지 알 수 있다
- 호스팅 업자가 209.172.34.3 을 [http://www.joes-hardware.com](http://www.joes-hardware.com/index.html) 에, 209.172.34.4 를 [http://www.marys-antiques.com](http://www.marys-antiques.com/index.html)에 할당하고 두 IP주소를 같은 물리 서버 장비에 연결해놨다고 해보자
  - 클라이언트 A는 [http://www.joes-hardware.com](http://www.joes-hardware.com/index.html)/index.html 를 요청한다
  - 클라이언트 A는 [http://www.joes-hardware.com](http://www.joes-hardware.com/index.html)의 IP주소를 요청해 209.172.34.3 을 얻는다
  - 클라이언트 A는 209.172.34.3에 있는 공용 웹 서버에 TCP커넥션을 맺는다
  - 클라이언트 A 는 “GET /index.html HTTP/1.0” 요창을 보낸다
  - 웹 서버가 응답을 전송하기에 앞서 실제 목적지 IP주소(209.172.34.3)를 기록하고 이것이 죠의 웹 사이트에 대한 가상 IP 주소라는 것을 판단하고 /joe 하위디렉터리에서 요청을 처리한다. /joe/index.html 페이지를 반환한다
- 가상 IP 호스팅은 잘 동작하지만 규모가 아주 큰 호스팅 업자에게는 약간 어려운 문제를 안겨준다
  - 일반적으로 컴퓨터 시스템이 연결할 수 있는 장비의 IP의 개수에는 제한이 있다
  - IP 주소는 희소 상품이다. 모든 웹사이트에 할당할 가상 IP 주소를 충분히 얻지 못할 수도 있다
  - IP주소가 부족한 문제는 호스팅 업자가 용량을 늘리려고 서버를 복제하면서 더 심각해진다. 부하 균형의 구조상, 각 복제된 서버에 IP 주소를 부여해야 하므로 IP주소는 복제 서버의 개수만큼 더 필요하게 된다
- 가상 IP 호스팅은 위와 같은 IP 주소 부족 문제가 생길 수 있음에도 불구하고 널리 쓰이는 방식이다

### `Host 헤더를 통한 가상 호스팅`

- 가상 호스트 명 정보를 받지 못하는 문제를 해결하려고 브라우저와 서버 개발자들은 서버가 원 호스트명을 받아 볼 수 있게 HTTP 를 확장했다
- 하지만 대부분의 서버가 경로 컴포넌트만 받아 요청을 처리할 수 있기 때문에 브라우저가 전체 URL을 보내더라도 소용없다
- 대신 모든 요청에 호스트명(그리고 포트)을 Host 확장 헤더에 기술해서 전달한다
  - Host 헤더는 관련 업체들이 HTTP/1.0 을 확장해 만든 HTTP/1.0+ 에서 처음 소개되었다
  - 1.1 명세를 따르려면 Host 헤더를 반드시 기술해야 한다
  - Host 헤더는 브라우저와 서버 대부분이 지원하지만 아직 몇몇 클라이언트와 서버는 지원하지 않는다
