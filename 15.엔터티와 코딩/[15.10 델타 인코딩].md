# 15.10 델타 인코딩

## 1. 개요

- 만약 클라이언트가 어떤 페이지의 만료된 사본을 갖고 있다면 클라이언트는 그 페이지에 대한 최신 인스턴스를 요청할 것이고 만약 서버가 그 페이지에 대해 더 새로운 인스턴스를 갖고 있다면 서버는 클라이언트에게 그 페이지를 보낼 것이고 설령 그 페이지가 실제로는 아주 일부분만 변경되었다 하더라도 전체 인스턴스를 보낼 것이다
- `새 페이지 전체를 보내는 대신 페이지에 대한 클라이언트 사본(변경량이 작은)에 대해 변경된 부분만을 서버가 보낸다면 클라이언트는 더 빨리 페이지를 얻을 수 있을 것이다`
- `델타 인코딩`은 `객체 전체가 아닌 변경된 부분에 대해서만 통신하여 전송량을 최적화`하는 HTTP 프로토콜의 확장
- 델타 인코딩은 일종의 인스턴스 조작인데, 왜냐하면 어떤 객체의 특정 인스턴스들에 대한 클라이언트와 서버 사이의 정보 교환에 의존하기 때문이다
  ![IMG_4F6027E1A591-1.jpeg](https://s3.us-west-2.amazonaws.com/secure.notion-static.com/2395e660-f55a-4770-a13a-f1cf6d2b3ee5/IMG_4F6027E1A591-1.jpeg?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=AKIAT73L2G45EIPT3X45%2F20230320%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20230320T125636Z&X-Amz-Expires=86400&X-Amz-Signature=3cbbb61a54e6430de1627a42dee0f854ec47c11d66cb031f03b70087f618ce7e&X-Amz-SignedHeaders=host&response-content-disposition=filename%3D%22IMG_4F6027E1A591-1.jpeg%22&x-id=GetObject)
- 그림은 델타 인코딩된 문서를 요청하고 생성하고 받고 적용하늡 아식에 대한 명확한 메커니즘을 묘사하고 있다
- 클라이언트는 페이지의 어떤 버전을 갖고 있는지 서버에게 말해주어야 하는데 이는 클라이언트가 페이지의 최신 버전에 대한 델타(변경된 부분)를 받아들일 의사가 있음을 의미한다
- 클라이언트는 자신이 갖고 잇는 현재 버전에 델타를 적용하기 위해 어떤 알고리즘을 갖고 있는지도 서버에게 말해주어야 한다
- 서버는 자신이 클라이언트가 갖고 있는 버전을 갖고 있는지, 그리고 어떻게 최신 버전과 클라이언트의 버전 사이의 델타를 계산할 것인지(두 객체의 차이점을 계싼하는 여러가지 알고리즘이 존재) 체크해야 한다
- 그러고 나서 델타를 계산해서 클라이언트에게 보내주고, 서버가 델타를 보내고 있음을 클라이언트에게 알려주고 페이지의 최신 버전에 대한 새 식별자를 명시해야 한다(이 식별자가 클라이언트의 오래된 버전에 델타를 적용하여 새로 만들어질 페이지의 버전이 되기 때문)
- 클라이언트는 자신이 갖고 있는 버전에 대한 유일한 식별자(지난번 응답의 ETag 헤더에 들어있던 것)를 If-None-Match 헤더에 담는다. 이것은 서버에게 `“네가 갖고 있는 최신 버전의 페이지가 이것과 같은 ETag 를 갖고 있지 않다면 최신 버전의 페이지를 보내달라”`고 말하는 클라이언트의 방식이다
- 그러면 이 If-None-Match 헤더에 의해 서버는 클라이언트에게 그 페이지의 최신 버전 전체를 보내게 될 것이다
- 그러나 클라이언트는 서버에게 A-IM 헤더를 보내서 자신이 페이지에 대한 델타를 받아들일 수 있음을 알려줄 수도 있다
  - A-IM 헤더은 Accept-Instance-Manipulation 의 줄임말
- 클라이언트는 페이지의 예전 버전과 델타를 이용해 최신 버전의 문서를 생성하는 방법에 대한 자신이 알고 있는 알고리즘을 A-IM 헤더 안에 명시한다
- 서버는 클라이언트에게 요청한 객체에 대해 객체 자체가 아닌 인스턴스 조작을 보내고 있ㅇ므을 말해주는 특별한 응답 코드(226 IM Used), 델타를 계산하기 위해 사용된 알고리즘을 명시한 IM(Instance-Manipulation)헤더, 새 ETag 헤더, 그리고 델타를 계산할 때 기반이 된 문서의 ETag 를 지정한 Delta-Base 헤더를 돌려준다
- 델타 인코딩에 사용되는 헤더들

| 헤더          | 설명                                                                                                                                               |
| ------------- | -------------------------------------------------------------------------------------------------------------------------------------------------- |
| ETag          | 문서의 각 인스턴스에 대한 유일한 식별자. 서버가 응답에 담아 보내주며 클라이언트는 이것을 다음번 요청에서 If-Match 와 If-None-Match 헤더에 사용한다 |
| If-None-Match | 클라이언트가 보내는 요청 헤더로, 서버가 클라이언트와 다른 버전의 문서를 갖고 있는 경우에 한해 그 문서를 요청한다                                   |
| A-IM          | 받아들일 수 있는 인스턴스 조작의 종류를 가리키는 클라이언트 요청 헤더                                                                              |
| IM            | 요청에 적용된 인스턴스 조작의 종류를 명시하는 서버의 응답 헤더. 응답 코드가 226 IM Used 일 때 이 헤더를 보낸다                                     |
| Delta-Base    | 델타를 생성하기 위해 사용된 기저 문서의 ETag 를 명시하는 서버 응답 헤더                                                                            |

## 2. 인스턴스 조작, 델타 생성기 그리고 델타 적용기(15.10.1)

- 클라이언트는 A-IM 헤더를 사용해서 자신이 받아들일 수 있는 인스턴스 조작의 종류를 명시할 수 있다
- 서버는 IM 헤더에 사용한 인스턴스 조작의 종류를 명시할 수 있다
- IANA 에 등록된 인스턴스 조작의 종류

| 종류    | 설명                                                                                                                |
| ------- | ------------------------------------------------------------------------------------------------------------------- |
| vcdiff  | vcdiff 알고리즘을 이용한 델타                                                                                       |
| diffe   | 유닉스 diff -e 명령을 이용한 델타                                                                                   |
| gdiff   | gdiff 알고리즘을 이용한 델타                                                                                        |
| gzip    | gzip 알고리즘을 이용한 압축                                                                                         |
| deflate | deflate 알고리즘을 이용한 압축                                                                                      |
| range   | 현재 응답이 범위 선택에 대한 결과인 부분 콘첸츠임을 말해주기 위해 서버 응답에서 사용된다                            |
| identit | 클라이언트가 identify 인스턴스 조작을 받아들일 의사가 있음을 말해주기 위해 클라이언트 요청의 A-IM 헤더에서 사용된다 |

- 델타 인코딩 명세는 A-IM 과 IM 헤더의 퐃맷을 자세히 정의한다
- 여기서는 이 헤더들에서 복수 개의 인스턴스 조작들을 지정할 수 있다는 것만 말해둔다
- 문서는 클라이언트에게 반환되기 전에 압축률을 극대화하기 위해 여러 번의 인스턴스 조작을 거칠 수 있다
- 델타 인코딩은 전송 시간을 줄일 수 있지만 구현하기가 까다로울 수 있다. 변경이 잦고 많은 사람이 접근하는 페이지를 상상해보면, 델타 인코딩을 지원하는 서버는 자신이 제공하는 페이지가 변경되는 매 순간의 사본을 모두 유지하고 있어야 한다. 그래야 클라이언트가 요청을 보냈을 때 그 클라이언트가 갖고 있는 사본과 최신 사본간의 차이점을 알아낼 수 있기 때문이다. `문서를 제공하는데 걸리는 시간이 줄어드는 대신, 서버는 문서의 과거 사본을 모두 유지하기 위해 디스크 공간을 더 늘려야한다.` 이는 전송량 감소로 얻은 이득을 금방 무의미하게 만들 것이다.
