## 19.2 WebDAV와 공동 저작

- 웹 분산 저작과 비저닝(Web DAV) 은 웹 배포 공동 작업에 또 다른 영역을 개척했다.
- **WebDAV**는 초기 협업 관련 기술의 수준이 낮았을 때 공동 저작에 적합한 플랫폼을 제공하려고 HTTP를 확장하는데 집중했다.
- 현재 어도비, 애플, IBM, 마이크로소프트, 넷스케이프, 노벨, 오라클, 제록스를 포함한 여러 업체로부터 지원을 마치며 IETE와 협력 관계에 있다.

### 19.2.1 WebDAV 메서드

WebDAV 는 새로운 HTTP 메소드 집합을 정의하고 수정했다.

- `PROPFIND` : 리소스의 속성을 읽는다.
- `PROPPATCH` : 한 개 이상의 리소스에 대한 한 개 이상의 속성을 설정한다.
- `MKCOL` : 콜렉션을 생성한다.
- `COPY` : 특정 원본지에서 특정 목적지로 리소스나 리소스의 집합을 복사한다.
- `MOVE` : 특정 소스에서 특정 목적자에 리소스나 리소스의 집합을 이동시킨다.
- `LOCK` : 하나 이상의 리소스를 잠근다.
- `UNLOCK` : 기존에 잠겨있는 리소스 잠금 해제

### 19.2.2 WebDAV와 XML

- WebDAV의 메서드는 요청과 응답 관련 정보를 모두 잘 다루어야 한다. HTTP는 보통 이 정보를 메시지 헤더에 담아 전송한다.
- 헤더에만 정보를 담아 전송하는 것은, 하나의 요청에 있는 여러 개의 리소스나 게층 관게에 있는 리소스들에 대한 정보를 헤더에 선택적으로 기술하기 어려운 점 등의 한계가 있다.
- WebDAV는 이 문제를 해결하려고 **XML을 지원**한다. XML은 구조화된 데이터를 표현할 때 사용하는 포맷으로, 메타 마크업 언어이다.
- WebDAV는 XML을 다음과 같은 용도로 사용한다.
    - 데이터를 어떻게 처리할 것인지 설명하는 명령 포맷
    - 서버의 복잡한 응답을 표현하는데 사용하는 포맷
    - 콜렉션과 리소스를 처리하는데 사용하는 커스텀 정보 포맷
    - 데이터 자체를 표현할 수 있는 유연한 포맷
    - 대부분의 국제화 관련 문제에 대한 훌륭한 채결책
- 전통적으로 XML 문서의 스키마 XML 문서 내부에서 자체적으로 참조하는 문서 타입의 정의(DTD)를 준수한다. 따라서 XML 문서를 해석하려고 할 때, DOCTYPE 정의 엔터티는 해당 XML 문서와 연관된 DTD파일의 이름을 제공한다.
- WebDAV는 DAV라는 별도의 XML 이름공간을 정의(XML 이름 공간은 요소나 속성 이름의 집합이다.)
- 이름 공간은 도메인 전체에서 유일한 이름을 보장함으로써 이름이 충돌되는 것을 완벽하ㅔㄱ 방지한다.

### 19.2.3 WebDAV 헤더

- `DAV` : WebDAV를 제공하는 서버와 통신할 때 사용
- `Depth` : 여러 수준의 계층 구조로 분류된 리소스에 WebDAV를 사용하기 위한 중요한 요소
    - Depth 가 0이면 해당 디렉토리만 제공 Depth 1이면 하위 디렉토리 1개까지 전부 제공
    - LOCK COPY MOVE  메소드를 쓸 때 Depth 헤더 사용
- `Destination` : COPY나 MOVE 메서드가 목적지 URI를 식별하는데 쓰인다.
- `If` : 정의되어 있는 상태 토큰은 lock 토큰 뿐이다. If 헤더는 조건 집합을 정의한다.
    - 조건에 맞지 않으면 요청은 실패로 돌아감
- `Lock-Token` : 제거되어야 할 잠금을 명시하는 용도로 UNLOCK 메서드에서 사용한다.
- `OverWrite` : 대상을 덮어 쓸 것인지 아닌지를 기술하는데 쓰이며 COPY나 MOVE 메서드에서 사용한다.
- `Timeout` : 클라이언트가 필요한 잠금 타임아웃 값을 기술하는데 사용하는 요청 헤더다.

### 19.2.4 WebDAV 잠금과 덮어쓰기 방지

- 공동 작업을 하는 경우 서로의 각자의 변경사항이 서로의 변경 사항과 연동되지 못하는 경우가 발생한다. 그 문제를 개선하기 위해 WebDAV는 **잠금**이라는 개념을 지원한다.
- 잠금 자체는 그 문제에 대한 완벽한 해결책은 아니다. 완벽한 해결책을 만들려면 버저닝과 메시징을 지원해야 한다.
- WebDAV는 두 가지 형식의 잠금
    - 리소스나 콜랙션에 대한 배타적 쓰기 잠금
    - 리소스나 콜렉션에 대한 공유된 쓰기 잠금
    - 배타적 쓰기 잠금 : 잠금 소유자가 쓸 수 있게 보장
    - 공유적 쓰기 점금 : 여러 사람이 하나의 문서에서 작업
- 잠금을 수행하기 위해서는 저자를 식별하는 매커니즘이 필요한데 이때 `다이제스트 인증`을 요구
- 잠금이 승인되면, 서버는 도멩니 전체에서 유일한 토큰을 클라이언트에 반환한다. 명세서에서는 이를 `opaquelocktoken` 잠금토큰 URI 스킴이라 부른다.
- 누군가 서버에 쓰기를 할 때 다이제스트 인증 실행 후 인증이 완료되면 토큰 보냄

### 19.2.5 LOCK 메서드

- WebDAV의 강력한 기능은 한 개의 LOCK 요청으로 여러 개의 리소스를 잠글 수 있다는 것이다.
- 전송된 XML에는 기본요소로 `<lockinfo>` 를 가진다. 이 구조안에는 3개의 하위 요소가 있다

**요청**

```tsx
 LOCK /ch-publish.fm

<?xml version =1.0>
<a:lockinfo>
<a:locktype>
<a:lockscope>
<a:ownner>
```

- `<locktype>` : 잠금 형식을 가리킨다.
- `<lockscope>` : 이것이 배타적 잠금인지 공유된 잠금인지 가리킨다.
- `<owner>` : 현재 잠금을 가지고 있는 사람이 기술되어 있는 필드

**응답**

- 요소에 포함된 `<activelock>`는 요청과 함께 전송된 정보를 담는 하위요소이며 위에 언급한 locktype,lockscope,owner 뿐 아니라 다음과 같은 하위요소를 가진다.
    - `<locktoken>` : URI 스킴에서 `opaquelocktoken`라 부르는 토큰으로 잠금을 식별하는데 사용한다. 기본적으로는 stateless 임.
    - `<depth>` : Depth 헤더와 같은 값을 가진다.
    - `<timeout>` : 잠금에 대한 타임아웃을 가리킨다.

**opaquelocktoken 스킴**

- `opaquelocktoken`스킴은 언제든 모든 리소스에 유일한 토큰을 제공하기 위해 설계되었다.
- 유일성을 보장하기 위해서, WebDAV 명세는 ISO-11578에 기술되어 있는 UUID 메커니즘을 사용한다.

`**<lockdiscovery>` XML 요소**

- 활성화되어 있는 잠금 매커니즘을 제공한다.

**잠금 갱신과 Timeout 헤더**

- 잠금을 갱신하려면, 클라이언트는 If 헤더에 잠금 토큰과 함께 잠금 요청을 다시 보내야 한다.
- 서버에게서 갱신된 timeout 값을 반영하는 대신 클라이언트는 필요한 timeout 값을 기술.
    
    `Timeout : Infinite, Second-86400`
    
- 서버가 반드시 옵션을 제공하는 것 아님
- `<timeout>` XML 요소에 잠금 파기 시간을 제공해야 한다.
- 기초적인 요소들이 있음에도 불구하고 손실 업데이트 문제를 완벽하게 해결 하지 못할 수 있다.
- 완벽한 해결을 위해, 비전 제어 기능을 포함한 협업 이벤트 시스템이 필요하다.

## 19.2.6 UNLOCK 메서드

- 리소스 관리 요청에서, WebDAV에서 UNLOCK이 성공
    - 다이제스트 인증을 성공적으로 완료
    - Lock-Token 헤더에 보내는 잠금 토큰이 맞는지 검사
    - HTTP 응답으로 잠금 성공 200 잠금 해제 성공 204
    - WebDAV 여러 리소스에 대해서 잠금 요청 207 /  접근 권한 없으면 403